#!/usr/bin/env node

// scripts/gdpr-audit.js
// GDPR Compliance Audit Script

const fs = require('fs');
const path = require('path');

// ANSI colors
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
};

const log = {
  info: (msg) => console.log(`${colors.blue}‚Ñπ${colors.reset} ${msg}`),
  success: (msg) => console.log(`${colors.green}‚úÖ${colors.reset} ${msg}`),
  warn: (msg) => console.log(`${colors.yellow}‚ö†Ô∏è${colors.reset} ${msg}`),
  error: (msg) => console.log(`${colors.red}‚ùå${colors.reset} ${msg}`),
  header: (msg) => console.log(`\n${colors.bright}${colors.cyan}üõ°Ô∏è ${msg}${colors.reset}\n`),
  section: (msg) => console.log(`\n${colors.bright}${msg}${colors.reset}`),
};

class GDPRAudit {
  constructor() {
    this.score = 0;
    this.maxScore = 0;
    this.issues = [];
    this.recommendations = [];
    this.checkedItems = [];
  }

  // P≈ôid√°n√≠ check pointu
  addCheck(name, weight = 1) {
    this.maxScore += weight;
    return {
      pass: () => {
        this.score += weight;
        this.checkedItems.push({ name, status: 'pass', weight });
        log.success(`${name}`);
      },
      fail: (reason, recommendation = null) => {
        this.checkedItems.push({ name, status: 'fail', weight, reason });
        this.issues.push({ name, reason, weight });
        if (recommendation) {
          this.recommendations.push(recommendation);
        }
        log.error(`${name}: ${reason}`);
      },
      warn: (reason, recommendation = null) => {
        this.score += weight * 0.5; // Partial credit for warnings
        this.checkedItems.push({ name, status: 'warn', weight, reason });
        if (recommendation) {
          this.recommendations.push(recommendation);
        }
        log.warn(`${name}: ${reason}`);
      }
    };
  }

  // Kontrola existence souboru
  checkFileExists(filePath, description, required = true) {
    const check = this.addCheck(description, required ? 2 : 1);
    const fullPath = path.resolve(filePath);
    
    if (fs.existsSync(fullPath)) {
      check.pass();
      return true;
    } else {
      if (required) {
        check.fail(
          `Soubor ${filePath} nenalezen`,
          `Vytvo≈ôte soubor ${filePath}`
        );
      } else {
        check.warn(
          `Voliteln√Ω soubor ${filePath} nenalezen`,
          `Zva≈æte vytvo≈ôen√≠ ${filePath} pro lep≈°√≠ funkcionalitet`
        );
      }
      return false;
    }
  }

  // Kontrola obsahu souboru
  checkFileContent(filePath, pattern, description, required = true) {
    const check = this.addCheck(description, required ? 2 : 1);
    
    try {
      const content = fs.readFileSync(path.resolve(filePath), 'utf8');
      
      if (typeof pattern === 'string') {
        if (content.includes(pattern)) {
          check.pass();
          return true;
        }
      } else if (pattern instanceof RegExp) {
        if (pattern.test(content)) {
          check.pass();
          return true;
        }
      }
      
      check.fail(
        `Pattern nenalezen v ${filePath}`,
        `P≈ôidejte po≈æadovan√Ω obsah do ${filePath}`
      );
      return false;
    } catch (error) {
      check.fail(
        `Chyba ƒçten√≠ ${filePath}: ${error.message}`,
        `Zkontrolujte existenci a opr√°vnƒõn√≠ souboru ${filePath}`
      );
      return false;
    }
  }

  // Kontrola environment variables
  checkEnvVariables() {
    log.section('üîê Environment Variables');
    
    const requiredVars = [
      'GDPR_ENCRYPTION_KEY',
      'GDPR_JWT_SECRET',
      'GDPR_CONTROLLER_NAME',
      'GDPR_CONTROLLER_EMAIL'
    ];

    const optionalVars = [
      'NEXT_PUBLIC_GA_ID',
      'NEXT_PUBLIC_FB_PIXEL_ID',
      'BREVO_API_KEY',
      'SMTP_HOST',
      'SMTP_USER'
    ];

    // Naƒçti .env.local pokud existuje
    const envPath = '.env.local';
    let envContent = '';
    
    if (fs.existsSync(envPath)) {
      envContent = fs.readFileSync(envPath, 'utf8');
    }

    // Kontrola povinn√Ωch promƒõnn√Ωch
    requiredVars.forEach(varName => {
      const check = this.addCheck(`Environment variable: ${varName}`, 2);
      
      if (process.env[varName] || envContent.includes(`${varName}=`)) {
        check.pass();
      } else {
        check.fail(
          `Chyb√≠ povinn√° promƒõnn√° ${varName}`,
          `P≈ôidejte ${varName} do .env.local`
        );
      }
    });

    // Kontrola voliteln√Ωch promƒõnn√Ωch
    optionalVars.forEach(varName => {
      const check = this.addCheck(`Optional: ${varName}`, 1);
      
      if (process.env[varName] || envContent.includes(`${varName}=`)) {
        check.pass();
      } else {
        check.warn(
          `Voliteln√° promƒõnn√° ${varName} nen√≠ nastavena`,
          `Zva≈æte nastaven√≠ ${varName} pro plnou funkcionaliteit`
        );
      }
    });
  }

  // Kontrola komponent
  checkComponents() {
    log.section('üß© GDPR Komponenty');
    
    const components = [
      'components/gdpr/CookieConsent.jsx',
      'components/gdpr/GDPRSettings.jsx',
      'components/gdpr/index.js'
    ];

    components.forEach(component => {
      this.checkFileExists(component, `Komponenta: ${path.basename(component)}`);
    });

    // Kontrola hooks
    this.checkFileExists('hooks/useCookieConsent.js', 'Hook: useCookieConsent');

    // Kontrola utility funkc√≠
    this.checkFileExists('lib/gdpr/utils.js', 'GDPR Utilities');
  }

  // Kontrola API endpoints
  checkAPIEndpoints() {
    log.section('üîå API Endpoints');
    
    const endpoints = [
      'pages/api/gdpr/export.js',
      'pages/api/gdpr/delete-request.js'
    ];

    endpoints.forEach(endpoint => {
      const exists = this.checkFileExists(endpoint, `API: ${path.basename(endpoint)}`);
      
      if (exists) {
        // Kontrola, zda endpoint nen√≠ jen placeholder
        this.checkFileContent(
          endpoint,
          /export default.*function|export.*handler/,
          `API Implementation: ${path.basename(endpoint)}`
        );
      }
    });
  }

  // Kontrola TypeScript typ≈Ø
  checkTypeScript() {
    log.section('üìù TypeScript Support');
    
    const tsConfigExists = this.checkFileExists('tsconfig.json', 'TypeScript config', false);
    
    if (tsConfigExists) {
      this.checkFileExists('types/gdpr.ts', 'GDPR TypeScript types', false);
    }
  }

  // Kontrola test≈Ø
  checkTests() {
    log.section('üß™ Testing Setup');
    
    this.checkFileExists('jest.config.js', 'Jest configuration', false);
    this.checkFileExists('jest.setup.js', 'Jest setup', false);
    this.checkFileExists('playwright.config.js', 'Playwright configuration', false);
    
    // Kontrola test slo≈æek
    const testDirs = ['tests', '__tests__', 'test'];
    let hasTests = false;
    
    testDirs.forEach(dir => {
      if (fs.existsSync(dir)) {
        hasTests = true;
      }
    });

    const check = this.addCheck('Test files', 1);
    if (hasTests) {
      check.pass();
    } else {
      check.warn(
        '≈Ω√°dn√© test soubory nenalezeny',
        'Vytvo≈ôte testy pro ovƒõ≈ôen√≠ GDPR funkcionality'
      );
    }
  }

  // Kontrola dokumentace
  checkDocumentation() {
    log.section('üìö Dokumentace');
    
    this.checkFileExists('README.md', 'README soubor');
    this.checkFileExists('docs/installation.md', 'Installation guide', false);
    this.checkFileExists('docs/legal-templates/privacy-policy-cz.md', 'Privacy policy template', false);
    
    // Kontrola obsahu README
    if (fs.existsSync('README.md')) {
      this.checkFileContent(
        'README.md',
        /GDPR|cookie|consent|privacy/i,
        'README obsahuje GDPR informace'
      );
    }
  }

  // Kontrola package.json
  checkPackageJson() {
    log.section('üì¶ Package Configuration');
    
    const exists = this.checkFileExists('package.json', 'Package.json');
    
    if (exists) {
      try {
        const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
        
        // Kontrola dependencies
        const requiredDeps = ['next', 'react', 'lucide-react'];
        requiredDeps.forEach(dep => {
          const check = this.addCheck(`Dependency: ${dep}`, 1);
          
          if (pkg.dependencies?.[dep] || pkg.devDependencies?.[dep]) {
            check.pass();
          } else {
            check.fail(
              `Chyb√≠ dependency: ${dep}`,
              `P≈ôidejte ${dep} do dependencies`
            );
          }
        });

        // Kontrola scripts
        const recommendedScripts = ['test', 'test:compliance', 'lint'];
        recommendedScripts.forEach(script => {
          const check = this.addCheck(`Script: ${script}`, 1);
          
          if (pkg.scripts?.[script]) {
            check.pass();
          } else {
            check.warn(
              `Chyb√≠ npm script: ${script}`,
              `P≈ôidejte "${script}" do package.json scripts`
            );
          }
        });

      } catch (error) {
        const check = this.addCheck('Package.json parsing', 2);
        check.fail(
          `Chyba parsov√°n√≠ package.json: ${error.message}`,
          'Opravte syntax v package.json'
        );
      }
    }
  }

  // Kontrola Git konfigurace
  checkGitSetup() {
    log.section('üîß Git Setup');
    
    this.checkFileExists('.gitignore', 'Git ignore soubor');
    
    if (fs.existsSync('.gitignore')) {
      this.checkFileContent(
        '.gitignore',
        '.env.local',
        'Gitignore obsahuje .env.local'
      );
    }

    this.checkFileExists('.github/workflows', 'GitHub Actions', false);
  }

  // Spu≈°tƒõn√≠ kompletn√≠ho auditu
  async runAudit() {
    log.header('GDPR Compliance Audit');
    
    console.log('Spou≈°t√≠m kontrolu GDPR compliance...\n');
    
    // Spus≈• v≈°echny kontroly
    this.checkEnvVariables();
    this.checkComponents();
    this.checkAPIEndpoints();
    this.checkTypeScript();
    this.checkTests();
    this.checkDocumentation();
    this.checkPackageJson();
    this.checkGitSetup();
    
    // Vypoƒç√≠tej final score
    const percentage = Math.round((this.score / this.maxScore) * 100);
    
    // Zobraz v√Ωsledky
    this.displayResults(percentage);
    
    return {
      score: this.score,
      maxScore: this.maxScore,
      percentage,
      issues: this.issues,
      recommendations: this.recommendations,
      checkedItems: this.checkedItems
    };
  }

  // Zobrazen√≠ v√Ωsledk≈Ø
  displayResults(percentage) {
    log.header('V√Ωsledky Auditu');
    
    console.log(`üìä Celkov√© sk√≥re: ${this.score}/${this.maxScore} (${percentage}%)\n`);
    
    // Color-coded score
    if (percentage >= 90) {
      log.success(`V√Ωborn√©! Va≈°e GDPR implementace je t√©mƒõ≈ô perfektn√≠. üåü`);
    } else if (percentage >= 75) {
      log.success(`Dobr√©! Va≈°e implementace je solidn√≠ s nƒõkolika drobn√Ωmi probl√©my. üëç`);
    } else if (percentage >= 50) {
      log.warn(`St≈ôedn√≠. Implementace pot≈ôebuje nƒõkolik vylep≈°en√≠. üîß`);
    } else {
      log.error(`Kritick√©! Implementace vy≈æaduje z√°sadn√≠ pr√°ci. üö®`);
    }

    // Zobraz issues
    if (this.issues.length > 0) {
      log.section('üî¥ Kritick√© probl√©my:');
      this.issues.forEach((issue, index) => {
        console.log(`${index + 1}. ${issue.name}: ${issue.reason}`);
      });
    }

    // Zobraz recommendations
    if (this.recommendations.length > 0) {
      log.section('üí° Doporuƒçen√≠:');
      this.recommendations.forEach((rec, index) => {
        console.log(`${index + 1}. ${rec}`);
      });
    }

    // Next steps
    log.section('üéØ Dal≈°√≠ kroky:');
    if (percentage < 90) {
      console.log('1. Opravte kritick√© probl√©my uveden√© v√Ω≈°e');
      console.log('2. Implementujte chybƒõj√≠c√≠ komponenty');
      console.log('3. Spus≈•te audit znovu: npm run test:compliance');
    } else {
      console.log('1. Otestujte implementaci s npm run test');
      console.log('2. Proveƒète E2E testy s npm run test:e2e');
      console.log('3. P≈ôipravte produkƒçn√≠ nasazen√≠');
    }

    console.log('\nüìû Pot≈ôebujete pomoc?');
    console.log('   üìß tech-podpora@webnamiru.site');
    console.log('   üêõ https://github.com/webnamiru/nextjs-gdpr-template/issues');
  }
}

// Spu≈°tƒõn√≠ auditu
async function main() {
  const audit = new GDPRAudit();
  
  try {
    const results = await audit.runAudit();
    
    // Export results do JSON pokud je po≈æadov√°no
    if (process.argv.includes('--json')) {
      const outputPath = 'gdpr-audit-results.json';
      fs.writeFileSync(outputPath, JSON.stringify(results, null, 2));
      log.info(`V√Ωsledky exportov√°ny do ${outputPath}`);
    }
    
    // Exit code based on score
    const exitCode = results.percentage >= 75 ? 0 : 1;
    process.exit(exitCode);
    
  } catch (error) {
    log.error(`Audit failed: ${error.message}`);
    process.exit(1);
  }
}

if (require.main === module) {
  main();
}

module.exports = GDPRAudit;